# How Video Calls Work in the System

## Overview

The video call system uses a combination of Socket.IO for signaling and Agora SDK for the actual video/audio communication. Both the doctor and patient need to connect to the socket system for call notifications, and both need to initialize Agora SDK for the video call itself.

## Socket Connection and Call Notifications

### How Calls Work Between Users

1. **Both Users Must Connect to Socket:**

   - Both doctor and patient must have an active socket connection to receive call notifications
   - The [GlobalIncomingCallHandler](file:///Users/pino/Documents/live/company/doc/src/components/GlobalIncomingCallHandler.tsx#L11-L195) component (mounted in [layout.tsx](file:///Users/pino/Documents/live/company/doc/src/app/layout.tsx#L57-L57)) handles socket connections automatically
   - Each user's socket connection is identified by their userId

2. **Call Initiation Flow:**

   - When a doctor or patient initiates a call, the system:
     - Creates a call object with caller/callee information
     - Emits an "initiate-call" event through the socket
     - The socket server routes this to the specific callee's socket connection
     - The callee receives an "incoming-call" event
     - The [GlobalIncomingCallHandler](file:///Users/pino/Documents/live/company/doc/src/components/GlobalIncomingCallHandler.tsx#L11-L195) displays the [IncomingCallModal](file:///Users/pino/Documents/live/company/doc/src/components/IncomingCallModal.tsx#L13-L228)

3. **Call Acceptance Flow:**
   - When the callee accepts the call:
     - An "accept-call" event is sent back through the socket
     - Both parties are redirected to their respective video call pages
     - Both pages receive the same Agora parameters (channel, token, etc.)

## Agora SDK Usage on Both Ends

### How Agora Works for Both Doctor and Patient

1. **Shared Agora Setup:**

   - Both doctor and patient use the same Agora App ID and channel name
   - Each user gets a unique token generated by the backend
   - Each user gets a unique UID for Agora (generated randomly during call setup)

2. **Connection Process:**

   - Both users connect to the same Agora channel
   - Each user publishes their own audio/video tracks
   - Each user subscribes to the other user's tracks
   - Agora handles the actual media streaming between users

3. **Parameter Flow:**
   ```
   Doctor initiates call → Backend generates Agora token →
   Call notification sent via socket → Patient accepts call →
   Both users redirected to video call pages with same parameters:
   - channelName (same for both)
   - token (unique for each user)
   - uid (unique for each user)
   - appId (same for both)
   ```

## Common Issues and Solutions

### Why Patient Might Not Receive Incoming Calls

1. **Socket Connection Issues:**

   - Patient's socket might not be connected
   - Patient's userId might not be correctly set in localStorage
   - Network issues preventing socket events from reaching the patient

2. **User Identification Problems:**
   - The calleeId in the call might not match the patient's actual userId
   - User info might not be properly stored in localStorage

### Why Both Ends Need Socket Connection

1. **Call Coordination:**

   - The socket system coordinates when both users should join the Agora channel
   - Without socket connection, users won't know when to start the video call
   - Socket handles call state (accepted, rejected, ended)

2. **Token Management:**
   - Agora tokens are short-lived and generated per call
   - The socket system helps ensure both users get valid tokens

## Technical Implementation Details

### Socket Client ([socket-client.ts](file:///Users/pino/Documents/live/company/doc/src/lib/socket-client.ts))

- Handles WebSocket connections for real-time communication
- Routes events to the correct user based on userId
- In the current mock implementation, simulates real WebSocket behavior

### Calling Service ([calling-service.ts](file:///Users/pino/Documents/live/company/doc/src/lib/calling-service.ts))

- Manages the call state and logic
- Handles call initiation, acceptance, rejection, and ending
- Coordinates with the socket client for event routing

### Global Incoming Call Handler ([GlobalIncomingCallHandler.tsx](file:///Users/pino/Documents/live/company/doc/src/components/GlobalIncomingCallHandler.tsx#L11-L195))

- Mounted in the root layout to listen for incoming calls on every page
- Automatically connects to the socket when user info is available
- Displays the incoming call modal when a call is received

### Video Call Components ([doctor/video-call/page.tsx](file:///Users/pino/Documents/live/company/doc/src/app/doctor/video-call/page.tsx#L17-L957) and [patient/video-call/page.tsx](file:///Users/pino/Documents/live/company/doc/src/app/patient/video-call/page.tsx#L19-L987))

- Both use Agora SDK to establish the actual video connection
- Receive the same channel parameters but with user-specific tokens
- Handle local and remote media streams

This system ensures that both doctor and patient can communicate in real-time, with proper call notifications and high-quality video streaming through Agora's infrastructure.
